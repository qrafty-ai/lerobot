---
phase: 02-learner-pi-rl-training-path
plan: 03
type: execute
wave: 3
depends_on:
  - 01
  - 02
files_modified:
  - src/lerobot/rl/learner.py
  - src/lerobot/rl/actor.py
  - src/lerobot/configs/train.py
  - tests/rl/test_actor_learner.py
  - tests/scripts/test_lerobot_train_recipe_routing.py
  - examples/rl/train_config_pirl_libero_smoke.json
autonomous: true
requirements:
  - LRN-03
  - LRN-04
must_haves:
  truths:
    - "PI-RL runs can save and resume from checkpoints using existing conventions."
    - "Resume/checkpoint metadata mismatch hard-fails with actionable diagnostics."
    - "Resumed PI-RL training restores optimizer/scheduler/counter state, not only weights."
    - "A self-contained `libero_10` PI-RL smoke training flow runs with documented two-terminal orchestration."
  artifacts:
    - path: src/lerobot/rl/learner.py
      provides: PI-RL checkpoint save/load and resume validation integration
    - path: src/lerobot/rl/actor.py
      provides: strict actor-side metadata mismatch enforcement on resumed streams
    - path: examples/rl/train_config_pirl_libero_smoke.json
      provides: runnable Phase 2 smoke config for learner+actor orchestration
    - path: tests/rl/test_actor_learner.py
      provides: resume/mismatch regression checks for PI-RL path
  key_links:
    - from: src/lerobot/rl/learner.py
      to: src/lerobot/rl/actor.py
      via: checkpoint metadata encoded in learner payload and validated by actor
      pattern: "config_path|config_hash|metadata"
    - from: examples/rl/train_config_pirl_libero_smoke.json
      to: python -m lerobot.rl.learner / actor
      via: shared config_path in two-terminal launch
      pattern: "recipe|pirl|env.task"
---

<objective>
Finalize PI-RL checkpoint/resume behavior and validate the LIBERO smoke training gate.

Purpose: Satisfy Phase 2 operational readiness with strict failure behavior and reproducible smoke orchestration.
Output: PI-RL checkpoint/resume support on existing conventions plus runnable `libero_10` smoke config/commands for learner+actor.
</objective>

<execution_context>
@/home/cc/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cc/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-learner-pi-rl-training-path/02-CONTEXT.md
@.planning/phases/02-learner-pi-rl-training-path/02-RESEARCH.md
@.planning/phases/02-learner-pi-rl-training-path/02-01-SUMMARY.md
@.planning/phases/02-learner-pi-rl-training-path/02-02-SUMMARY.md
@src/lerobot/rl/learner.py
@src/lerobot/rl/actor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce PI-RL checkpoint/resume metadata continuity with hard-fail mismatch</name>
  <files>src/lerobot/rl/learner.py, src/lerobot/rl/actor.py, src/lerobot/configs/train.py</files>
  <action>Extend learner save/load training state handling so PI-RL resume path preserves recipe-critical metadata (recipe, variant, config-path/hash continuity) and restores PI-RL training state (PI-RL optimizer state, scheduler state if used, and step counters) using existing checkpoint conventions and latest-pointer flow. Keep actor-side mismatch checks strict: any mismatch between resumed learner metadata and actor-local preflight context must hard-fail with actionable fields and expected values. Do not introduce a new checkpoint format.</action>
  <verify>Run targeted resume/mismatch tests and ensure errors include both actor and learner metadata values for diagnosis.</verify>
  <done>PI-RL checkpoint/resume restores full training continuity (weights + optimizer/scheduler/counters), and metadata mismatch always stops execution with actionable diagnostics.</done>
</task>

<task type="auto">
  <name>Task 2: Add runnable LIBERO smoke config and training orchestration artifacts</name>
  <files>examples/rl/train_config_pirl_libero_smoke.json, tests/scripts/test_lerobot_train_recipe_routing.py</files>
  <action>Create a smoke-first `libero_10` config artifact for two-terminal launch (`python -m lerobot.rl.learner --config_path ...` then `python -m lerobot.rl.actor --config_path ...`) with `recipe=pi-rl`, XVLA policy, and conservative smoke defaults. Ensure self-contained setup assumptions are explicit in verification commands (`pip install -e ".[libero]"`, `MUJOCO_GL=egl`). Add/adjust routing tests so standard `lerobot-train` still rejects PI-RL mode and points users to distributed learner/actor orchestration.</action>
  <verify>Run `pytest -sv tests/scripts/test_lerobot_train_recipe_routing.py` and validate the smoke config loads via parser/validation without schema errors.</verify>
  <done>A reproducible PI-RL LIBERO smoke config and launch path exist, and train-entry routing remains deterministic.</done>
</task>

<task type="auto">
  <name>Task 3: Execute Phase 2 smoke gate and capture objective completion evidence</name>
  <files>tests/rl/test_actor_learner.py</files>
  <action>Run a bounded smoke gate covering checkpoint/resume behavior and PI-RL learner+actor startup with shared config path in `libero_10` mode. Prefer deterministic CI-safe checks first (unit/integration). Define a mandatory fallback gate for environments without LIBERO dependencies: config parse succeeds, learner and actor processes both start with shared config, and at least one parameter update exchange is observed without metadata mismatch. When LIBERO dependencies are present, run minimal real-process smoke commands with `MUJOCO_GL=egl`. Record exact commands and pass/fail outputs in the execution summary so Phase 2 gate is auditable.</action>
  <verify>Execute targeted RL tests. Always verify fallback gate (config load + learner/actor startup + one update exchange). If LIBERO deps are available, run learner+actor smoke startup commands with `MUJOCO_GL=egl` and confirm startup completes without metadata mismatch or routing errors.</verify>
  <done>LRN-03 and LRN-04 are evidenced by passing resume/mismatch checks plus either (a) successful self-contained PI-RL LIBERO smoke launch or (b) mandatory fallback gate in non-LIBERO environments.</done>
</task>

</tasks>

<verification>
- Resume path uses existing checkpoint conventions and latest pointer.
- Mismatch failures are explicit and actionable.
- LIBERO `libero_10` smoke launch commands are runnable and validated.
</verification>

<success_criteria>
- LRN-03 checkpoint/resume behavior is complete and deterministic.
- LRN-04 smoke training orchestration is reproducible with two-terminal flow.
- Phase 2 remains training-gated (evaluation deferred to Phase 3).
</success_criteria>

<output>
After completion, create `.planning/phases/02-learner-pi-rl-training-path/02-03-SUMMARY.md`
</output>
