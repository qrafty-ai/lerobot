---
phase: 01-pi-rl-recipe-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 01
  - 02
files_modified:
  - tests/configs/test_train_config.py
  - tests/rl/test_actor.py
  - tests/rl/test_actor_learner.py
  - tests/rl/test_learner_service.py
autonomous: true
requirements:
  - RCP-01
  - RCP-02
  - RCP-03
must_haves:
  truths:
    - "PI-RL recipe selection behavior is covered by automated tests."
    - "XVLA-only eligibility for PI-RL is enforced by tests."
    - "Variant requirement and error-guidance behavior are regression-protected."
  artifacts:
    - path: tests/configs/test_train_config.py
      provides: recipe/variant config validation tests
    - path: tests/rl/test_actor.py
      provides: actor startup preflight tests for PI-RL mode
    - path: tests/rl/test_actor_learner.py
      provides: actor-learner shared config/mismatch tests
    - path: tests/rl/test_learner_service.py
      provides: learner-side guard behavior checks
  key_links:
    - from: tests/configs/test_train_config.py
      to: src/lerobot/configs/train.py
      via: validation behavior assertions
      pattern: "pi-rl|flow-noise|flow-sde"
    - from: tests/rl/test_actor_learner.py
      to: src/lerobot/rl/actor.py
      via: startup/mismatch integration assertions
      pattern: "config_path|recipe"
---

<objective>
Add focused tests proving Phase 1 PI-RL recipe behavior and XVLA compatibility.

Purpose: Lock in config/routing semantics and prevent regressions while Phase 2 extends learner internals.
Output: Config + RL startup tests that cover valid and invalid PI-RL recipe permutations.
</objective>

<execution_context>
@/home/cc/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cc/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-pi-rl-recipe-foundation/01-CONTEXT.md
@.planning/phases/01-pi-rl-recipe-foundation/01-RESEARCH.md
@src/lerobot/configs/train.py
@src/lerobot/rl/actor.py
@src/lerobot/rl/learner.py
@tests/rl/test_actor.py
@tests/rl/test_actor_learner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config-level tests for PI-RL recipe and variant validation</name>
  <files>tests/configs/test_train_config.py</files>
  <action>Create positive and negative tests for recipe selection (`pi-rl` canonical spelling), required variant (`flow-noise` / `flow-sde`), and variant knob validation. Assert errors include field path, invalid value, and concrete fix hint.</action>
  <verify>Run `pytest -sv tests/configs/test_train_config.py -k "pi_rl or recipe or variant"`.</verify>
  <done>Config tests reliably detect invalid recipe/variant input and preserve valid PI-RL + default behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Add RL startup tests for XVLA eligibility and actor/learner config consistency</name>
  <files>tests/rl/test_actor.py, tests/rl/test_actor_learner.py, tests/rl/test_learner_service.py</files>
  <action>Add targeted tests covering: XVLA+PI-RL allowed path, non-XVLA+PI-RL rejection with allowed-policy list, actor/learner config path mismatch hard-fail via metadata comparison (path + hash) with both values surfaced in failure output, and deterministic preflight startup summary content for valid PI-RL startup. Keep tests isolated from hardware dependencies.</action>
  <verify>Run `pytest -sv tests/rl/test_actor.py tests/rl/test_actor_learner.py tests/rl/test_learner_service.py -k "pi_rl or recipe or config or hash or preflight"`.</verify>
  <done>Runtime selection and mismatch handling behavior is covered and reproducible in CI-friendly tests.</done>
</task>

<task type="auto">
  <name>Task 3: Add baseline compatibility test matrix for Phase 1 acceptance gates</name>
  <files>tests/configs/test_train_config.py, tests/rl/test_actor_learner.py</files>
  <action>Introduce a concise matrix-style test set that explicitly validates roadmap success criteria: PI-RL selectable with XVLA, policy taxonomy unchanged, and startup guards passing/failing in expected cases.</action>
  <verify>Run the full targeted suite and ensure all matrix cases pass with deterministic assertions.</verify>
  <done>Phase 1 acceptance criteria are represented by executable tests, not only implementation assumptions.</done>
</task>

</tasks>

<verification>
- Config test file covers canonical recipe, required variant, and error guidance.
- RL tests cover eligibility allow/deny and actor-learner mismatch handling.
- Targeted test commands pass locally.
</verification>

<success_criteria>
- Requirements RCP-01/02/03 each map to explicit test assertions.
- Test names/messages make failure reasons obvious.
- Phase 1 gates can be evaluated by running focused test subsets.
</success_criteria>

<output>
After completion, create `.planning/phases/01-pi-rl-recipe-foundation/01-03-SUMMARY.md`
</output>
